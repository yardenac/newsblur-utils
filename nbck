#!/usr/bin/python3

import configparser
import http.cookiejar
import json
import os
import urllib.parse
import urllib.request
import ssl
import sys

#### CONFIG ####

config_global = configparser.ConfigParser()
config_global['DEFAULT'] = {
	'username': 'user',
	'password': 'password',
	'url': 'https://newsblur.com/',
	'configfile' : os.environ['HOME'] + '/.config/newsblur/login',
}
config_global.read(config_global['DEFAULT']['configfile'])
config = config_global['DEFAULT']



#### CONNECT ####

opener = urllib.request.build_opener()

# set up cookies
opener.add_handler(urllib.request.HTTPCookieProcessor(http.cookiejar.CookieJar()))

# set up secure TLS
context = ssl.SSLContext(ssl.PROTOCOL_TLSv1)
context.verify_mode = ssl.CERT_REQUIRED
context.load_verify_locations(capath="/etc/ssl/certs")
opener.add_handler(urllib.request.HTTPSHandler(context=context))

def nbtry(opener,*args):
    response = json.loads(opener.open(*args).read().decode())
    if (response['result'] != 'ok'):
        print("connection failed...")
        return(0)
    if (response['code'] != 1):
        for e in response['errors']['__all__']:
                print(e)
        return(0)
    return(response)

# log in
authdata = urllib.parse.urlencode({
	"username" : config["username"],
	"password" : config["password"],
}).encode()

if not nbtry(opener,config['url']+"api/login",authdata):
    print("login failed")
    sys.exit(1)


#### DO STUFF ####

print(opener.open(config['url']+"reader/feeds").read().decode())



#### CLEANUP ####

if not nbtry(opener,config['url']+"api/logout"):
    print("logout failed")
    sys.exit(1)
