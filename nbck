#!/usr/bin/python3

import configparser
import http.cookiejar
import os
import urllib.parse
import urllib.request
import ssl

#### CONFIG ####

config_global = configparser.ConfigParser()
config_global['DEFAULT'] = {
	'username': 'user',
	'password': 'password',
	'url': 'https://newsblur.com/',
	'configfile' : os.environ['HOME'] + '/.config/newsblur/login',
}
config_global.read(config_global['DEFAULT']['configfile'])
config = config_global['DEFAULT']



#### CONNECT ####

opener = urllib.request.build_opener()

# set up cookies
cj = http.cookiejar.CookieJar()
opener.add_handler(urllib.request.HTTPCookieProcessor(cj))

# set up secure TLS
context = ssl.SSLContext(ssl.PROTOCOL_TLSv1)
context.verify_mode = ssl.CERT_REQUIRED
context.load_verify_locations(capath="/etc/ssl/certs")
opener.add_handler(urllib.request.HTTPSHandler(context=context))

# log in
authdata = urllib.parse.urlencode({
	"username" : config["username"],
	"password" : config["password"],
}).encode()
print(opener.open(config['url']+"api/login",authdata).read().decode())



#### DO STUFF ####

print(opener.open(config['url']+"reader/feeds").read().decode())



#### CLEANUP ####

print(opener.open(config['url']+"api/logout").read().decode())
